[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Technical Offer",
  "enabled": 0,
  "modified": "2025-12-02 22:00:21.284263",
  "module": "BOQ",
  "name": "BOQ Test",
  "script": "// MAIN FORM\r\nfrappe.ui.form.on(\"Sales BOQ\", {\r\n\r\n    onload(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n    },\r\n\r\n    refresh(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n    },\r\n\r\n    // RUN FILTER LOGIC WHEN ANY SEARCH FIELD CHANGES\r\n    search_item_group(frm) { apply_item_filter(frm); },\r\n    search_item_name(frm) { apply_item_filter(frm); },\r\n    search_moc(frm)       { apply_item_filter(frm); },\r\n    search_make(frm)      { apply_item_filter(frm); },\r\n    search_size(frm)      { apply_item_filter(frm); },\r\n\r\n    // CLEAR BUTTON\r\n    clear(frm) {\r\n        clear_filters(frm);\r\n        apply_item_filter(frm);\r\n    }\r\n});\r\n\r\n\r\n// APPLY FILTER TO CHILD TABLE\r\nfunction apply_item_filter(frm) {\r\n\r\n    frm.fields_dict.items.grid.get_field(\"item_code\").get_query = function(doc, cdt, cdn) {\r\n        let f = {};\r\n\r\n        if (frm.doc.search_item_group) f.item_group   = frm.doc.search_item_group;\r\n        if (frm.doc.search_item_name)  f.item_name    = [\"like\", `%${frm.doc.search_item_name}%`];\r\n        if (frm.doc.search_moc)        f.custom_moc   = [\"like\", `%${frm.doc.search_moc}%`];\r\n        if (frm.doc.search_make)       f.custom_make  = [\"like\", `%${frm.doc.search_make}%`];\r\n        if (frm.doc.search_size)       f.custom_size  = [\"like\", `%${frm.doc.search_size}%`];\r\n\r\n        return { filters: f };\r\n    };\r\n\r\n    frm.refresh_field(\"items\");\r\n}\r\n\r\n\r\n// CLEAR ALL SEARCH FIELDS\r\nfunction clear_filters(frm) {\r\n\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\"\r\n    ];\r\n\r\n    fields.forEach(f => frm.set_value(f, \"\"));\r\n\r\n    frm.refresh_fields();\r\n}\r\n\r\n\r\n// HIDE SEARCH FIELDS AFTER SUBMIT\r\nfunction toggle_search_fields(frm) {\r\n\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\"\r\n    ];\r\n\r\n    if (frm.doc.docstatus === 1) {\r\n        // SUBMITTED ‚Üí hide search fields\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 1);\r\n            frm.set_df_property(f, \"hidden\", 1);\r\n        });\r\n\r\n        // HIDE CLEAR BUTTON\r\n        frm.set_df_property(\"clear\", \"hidden\", 1);\r\n        frm.set_df_property(\"clear\", \"read_only\", 1);\r\n    }\r\n    else {\r\n        // DRAFT ‚Üí show search fields\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 0);\r\n            frm.set_df_property(f, \"hidden\", 0);\r\n        });\r\n\r\n        // SHOW CLEAR BUTTON\r\n        frm.set_df_property(\"clear\", \"hidden\", 0);\r\n        frm.set_df_property(\"clear\", \"read_only\", 0);\r\n    }\r\n\r\n    frm.refresh_fields();\r\n}\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 0,
  "modified": "2025-12-04 13:00:13.417158",
  "module": null,
  "name": "Item",
  "script": "// ----------------------\r\n// PURCHASE BOQ SCRIPT\r\n// ----------------------\r\n\r\nfrappe.ui.form.on(\"Purchase BOQ\", {\r\n\r\n    // Trigger when Sales BOQ is selected\r\n    sales_boq(frm) {\r\n\r\n        if (!frm.doc.sales_boq) return;\r\n\r\n        frappe.show_alert(\"Fetching Sales BOQ...\", \"blue\");\r\n\r\n        // Clear old rows\r\n        frm.clear_table(\"items\");\r\n        frm.clear_table(\"services\");\r\n        frm.refresh_fields([\"items\", \"services\"]);\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Sales BOQ\",\r\n                name: frm.doc.sales_boq\r\n            },\r\n            freeze: true,\r\n            freeze_message: \"Loading Sales BOQ...\",\r\n            callback: function(r) {\r\n\r\n                if (!r.message) {\r\n                    frappe.msgprint(\"No Sales BOQ found\");\r\n                    return;\r\n                }\r\n\r\n                let sales = r.message;\r\n                let stock_promises = [];\r\n\r\n                // Set customer\r\n                if (sales.customer) {\r\n                    frm.set_value(\"customer\", sales.customer);\r\n                }\r\n\r\n                // ------------------\r\n                // COPY ITEMS\r\n                // ------------------\r\n                (sales.items || []).forEach(src => {\r\n\r\n                    let child = frm.add_child(\"items\");\r\n\r\n                    child.item_category = src.item_category;\r\n                    child.item_code     = src.item_code;\r\n                    child.item_name     = src.item_name;\r\n                    child.qyt           = src.qyt;\r\n                    child.uom           = src.uom;\r\n\r\n                    // fetch standard_rate\r\n                    if (child.item_code) {\r\n\r\n                        frappe.call({\r\n                            method: \"frappe.client.get_value\",\r\n                            args: {\r\n                                doctype: \"Item\",\r\n                                filters: { name: child.item_code },\r\n                                fieldname: \"standard_rate\"\r\n                            },\r\n                            callback: function(r) {\r\n                                child.rate   = r.message?.standard_rate || 0;\r\n                                child.amount = (child.rate || 0) * (child.qyt || 0);\r\n                                frm.refresh_field(\"items\");\r\n                            }\r\n                        });\r\n\r\n                        // stock fetch with Promise\r\n                        let p = new Promise(resolve => {\r\n                            frappe.call({\r\n                                method: \"frappe.client.get_list\",\r\n                                args: {\r\n                                    doctype: \"Bin\",\r\n                                    filters: { item_code: child.item_code },\r\n                                    fields: [\"actual_qty\"]\r\n                                },\r\n                                callback: stock => {\r\n                                    let total = 0;\r\n                                    if (stock.message?.length) {\r\n                                        total = stock.message.reduce((a, s) => a + (s.actual_qty || 0), 0);\r\n                                    }\r\n                                    child.current_stock = total;\r\n                                    resolve();\r\n                                }\r\n                            });\r\n                        });\r\n\r\n                        stock_promises.push(p);\r\n                    }\r\n                });\r\n\r\n                // ------------------\r\n                // COPY SERVICES\r\n                // ------------------\r\n                (sales.services || []).forEach(src => {\r\n\r\n                    let child = frm.add_child(\"services\");\r\n\r\n                    child.service_code = src.service_code;\r\n                    child.service_name = src.service_name;\r\n                    child.description  = src.description;\r\n                    child.service_cost = src.service_cost || 0;\r\n                    child.discount     = 0;\r\n\r\n                });\r\n\r\n                // finish\r\n                Promise.all(stock_promises).then(() => {\r\n                    frm.refresh_fields([\"items\", \"services\"]);\r\n                    highlight_low_stock(frm);\r\n                    frappe.show_alert(\"Items & Services Loaded ‚úî\", \"green\");\r\n                });\r\n            }\r\n        });\r\n    },\r\n\r\n    // Auto trigger on new doc load\r\n    onload(frm) {\r\n        if (frm.doc.sales_boq && frm.is_new()) {\r\n            frm.trigger(\"sales_boq\");\r\n        }\r\n    },\r\n\r\n    // Refresh UI\r\n    refresh(frm) {\r\n        highlight_low_stock(frm);\r\n\r\n        // Auto refetch if table empty\r\n        if (frm.doc.sales_boq && (!frm.doc.items?.length && !frm.doc.services?.length)) {\r\n            frm.trigger(\"sales_boq\"); // FIXED\r\n        }\r\n\r\n        // Create Final BOQ Button only if submitted\r\n        if (frm.doc.docstatus === 1 || frm.doc.docstatus === 0) {\r\n            frm.add_custom_button(\"Create Final BOQ\", function () {\r\n    \r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Final BOQ\",\r\n            filters: {\r\n                purchase_boq: frm.doc.name\r\n            },\r\n            fields: [\"name\"],\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n\r\n            if (r.message && r.message.length > 0) {\r\n                // -------------------------------------\r\n                // FINAL BOQ ALREADY EXISTS ‚Üí OPEN IT\r\n                // -------------------------------------\r\n                frappe.show_alert(\"Opening existing Final BOQ...\", \"green\");\r\n                frappe.set_route(\"Form\", \"Final BOQ\", r.message[0].name);\r\n                return;\r\n            }\r\n\r\n            // -------------------------------------\r\n            // NO FINAL BOQ ‚Üí CREATE NEW ONE\r\n            // -------------------------------------\r\n            frappe.model.with_doctype(\"Final BOQ\", () => {\r\n                let doc = frappe.model.get_new_doc(\"Final BOQ\");\r\n                doc.purchase_boq = frm.doc.name;\r\n                doc.name1 = frm.doc.name.replace(/-P$/, \"\");\r\n\r\n                frappe.set_route(\"Form\", doc.doctype, doc.name);\r\n            });\r\n\r\n        }\r\n    });\r\n\r\n}, \"Actions\");\r\n        }\r\n    }\r\n});\r\n\r\n// ------------------\r\n// ITEM EVENTS\r\n// ------------------\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        row.amount = (row.qyt || 0) * (row.rate || 0);\r\n        frm.refresh_field(\"items\");\r\n    },\r\n    rate(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        row.amount = (row.qyt || 0) * (row.rate || 0);\r\n        frm.refresh_field(\"items\");\r\n    }\r\n});\r\n\r\n// ------------------\r\n// HIGHLIGHT LOW STOCK\r\n// ------------------\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict.items?.grid?.grid_rows) return;\r\n\r\n    setTimeout(() => {\r\n        frm.fields_dict.items.grid.grid_rows.forEach(row => {\r\n            let d = row.doc;\r\n            $(row.row).css(\r\n                \"background-color\",\r\n                d.current_stock < d.qyt ? \"#ffcccc\" : \"\"\r\n            );\r\n        });\r\n    }, 300);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 1,
  "modified": "2026-01-02 14:22:38.617301",
  "module": "CRM",
  "name": "Opportunity Script",
  "script": "frappe.ui.form.on('Opportunity', {\r\n    refresh(frm) {\r\n        if (frm.is_new()) return;\r\n\r\n        frm.add_custom_button(__('Technical Offer'), () => {\r\n\r\n            const party_map = {\r\n                Customer:  { doctype: \"Customer\",  field: \"customer_name\" },\r\n                Lead:      { doctype: \"Lead\",      field: \"lead_name\" },\r\n                Prospect:  { doctype: \"Prospect\",  field: \"company_name\" }\r\n            };\r\n\r\n            let cfg = party_map[frm.doc.opportunity_from];\r\n\r\n            if (!cfg || !frm.doc.party_name) {\r\n                frappe.msgprint(\"Party not found\");\r\n                return;\r\n            }\r\n\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: frm.doc.opportunity_from,\r\n                    name: frm.doc.party_name,\r\n                    fieldname: cfg.field\r\n                },\r\n                callback(r) {\r\n\r\n                    let party = r.message ? r.message[cfg.field] : \"\";\r\n\r\n                    // Pass everything via route_options\r\n                    frappe.route_options = {\r\n                        opportunity: frm.doc.name,\r\n                        opportunity_from: frm.doc.opportunity_from,\r\n                        party: party,\r\n                        __from_opportunity: 1\r\n                    };\r\n\r\n                    // Create new Technical Offer\r\n                    frappe.new_doc(\"Technical Offer\");\r\n\r\n                    // WAIT until form is loaded\r\n                    let interval = setInterval(() => {\r\n\r\n                        if (\r\n                            cur_frm &&\r\n                            cur_frm.doctype === \"Technical Offer\" &&\r\n                            cur_frm.doc.__islocal\r\n                        ) {\r\n                            clearInterval(interval);\r\n\r\n                            // Header fields\r\n                            cur_frm.set_value(\"opportunity\", frm.doc.name);\r\n                            cur_frm.set_value(\"opportunity_from\", frm.doc.opportunity_from);\r\n                            cur_frm.set_value(\"party\", party);\r\n\r\n                            // Copy items\r\n                            if (frm.doc.items && frm.doc.items.length) {\r\n                                frm.doc.items.forEach(item => {\r\n                                    let row = frappe.model.add_child(\r\n                                        cur_frm.doc,\r\n                                        \"Sales BOQ Item\",\r\n                                        \"items\"\r\n                                    );\r\n\r\n                                    row.item_code = item.item_code;\r\n                                    row.item_name = item.item_name;\r\n                                    row.uom = item.uom;\r\n                                    row.qty = item.qty || 1;\r\n                                });\r\n                            }\r\n\r\n                            cur_frm.refresh_fields();\r\n                        }\r\n\r\n                    }, 300);\r\n                }\r\n            });\r\n\r\n        }, __(\"Create\"));\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Opportunity', {\r\n//     refresh(frm) {\r\n//         if (frm.is_new()) return;\r\n        \r\n//         frm.add_custom_button(__('Technical Offer'), async () => {\r\n//             const party_map = {\r\n//                 Customer:  { doctype: \"Customer\",  field: \"customer_name\" },\r\n//                 Lead:      { doctype: \"Lead\",      field: \"lead_name\" },\r\n//                 Prospect:  { doctype: \"Prospect\",  field: \"company_name\" }\r\n//             };\r\n            \r\n//             let party = \"\";\r\n//             let cfg = party_map[frm.doc.opportunity_from];\r\n            \r\n//             // Fetch the actual customer/lead/prospect name\r\n//             if (cfg && frm.doc.party_name) {\r\n//                 let r = await frappe.db.get_value(\r\n//                     frm.doc.opportunity_from,\r\n//                     frm.doc.party_name,\r\n//                     cfg.field\r\n//                 );\r\n//                 party = r?.message?.[cfg.field];\r\n                \r\n                \r\n//             }\r\n            \r\n//             // Final fallback\r\n            \r\n//             // Set route options\r\n//             frappe.route_options = {\r\n//                 opportunity: frm.doc.name,\r\n//                 opportunity_from: frm.doc.opportunity_from,\r\n//                 party: party  // This sets the party field\r\n//             };\r\n            \r\n//             frappe.new_doc(\"Technical Offer\", doc => {\r\n//                 // Explicitly set all fields\r\n//                 doc.opportunity = frm.doc.name;\r\n//                 doc.opportunity_from = frm.doc.opportunity_from;\r\n//                 doc.party = party; \r\n//                 console.log(\"Party fetched:\", party);\r\n//                 console.log(\"Party Name:\", frm.doc.party_name);\r\n//                 console.log(\"Items:\", frm.doc.items);\r\n//                 // Add items\r\n//                 frm.doc.items?.forEach(item => {\r\n//                     let row = frappe.model.add_child(doc, \"Sales BOQ Item\", \"items\");\r\n//                     row.item_code = item.item_code;\r\n//                     row.item_name = item.item_name;\r\n//                     row.uom = item.uom;\r\n//                     row.qty = item.qty ||0;\r\n//                 });\r\n\r\n                \r\n//                 // Refresh to show all values\r\n//                 cur_frm.refresh_fields();\r\n//             });\r\n//         }, __(\"Create\"));\r\n//     }\r\n// });",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Technical Offer",
  "enabled": 1,
  "modified": "2026-01-02 12:09:08.600773",
  "module": "BOQ",
  "name": "BOQ Sales",
  "script": "// =====================================================\r\n// MAIN FORM\r\n// =====================================================\r\nfrappe.ui.form.on(\"Technical Offer\", {\r\n\r\n    onload(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n        setup_short_forms_dropdown(frm, \"MOC\", \"search_moc\");\r\n        setup_short_forms_dropdown(frm, \"Make\", \"search_make\");\r\n\r\n        // Lock old revisions (UX only)\r\n        if (!frm.is_new() && !frm.doc.is_latest) {\r\n            frm.disable_form();\r\n            frm.set_intro(\r\n                __(\"This is an old revision and cannot be edited.\"),\r\n                \"orange\"\r\n            );\r\n        }\r\n    },\r\n\r\n    refresh(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n        setup_short_forms_dropdown(frm, \"MOC\", \"search_moc\");\r\n        setup_short_forms_dropdown(frm, \"Make\", \"search_make\");\r\n\r\n        // --------------------------------------------\r\n        // REVISION (OPTION 4)\r\n        // --------------------------------------------\r\n        if (!frm.is_new() && frm.doc.is_latest) {\r\n\r\n            // Optional: allow revision only after submit\r\n            // if (frm.doc.docstatus !== 1) return;\r\n\r\n            frm.add_custom_button(\r\n                __(\"Create Revision\"),\r\n                () => {\r\n                    frappe.confirm(\r\n                        __(\"Create a new revision of this Technical Offer?\"),\r\n                        () => {\r\n                            frappe.call({\r\n                                method: \"boq.boq.doctype.technical_offer.technical_offer.create_new_revision\",\r\n                                args: { docname: frm.doc.name },\r\n                                freeze: true,\r\n                                freeze_message: __(\"Creating new revision...\"),\r\n                                callback(r) {\r\n                                    if (r.message) {\r\n                                        frappe.show_alert({\r\n                                            message: __(\"Revision created successfully\"),\r\n                                            indicator: \"green\"\r\n                                        });\r\n                                        frappe.set_route(\r\n                                            \"Form\",\r\n                                            \"Technical Offer\",\r\n                                            r.message\r\n                                        );\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                    );\r\n                },\r\n                __(\"Actions\")\r\n            );\r\n        }\r\n\r\n        // --------------------------------------------\r\n        // CREATE / OPEN PURCHASE BOQ\r\n        // --------------------------------------------\r\n        if (frm.doc.docstatus === 1) {\r\n\r\n            frm.add_custom_button(\"Create Purchase BOQ\", function () {\r\n\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Purchase BOQ\",\r\n                        filters: { sales_boq: frm.doc.name },\r\n                        fields: [\"name\"],\r\n                        limit: 1\r\n                    },\r\n                    callback(res) {\r\n\r\n                        if (res.message && res.message.length > 0) {\r\n                            frappe.show_alert(\"Opening existing Purchase BOQ...\", \"green\");\r\n                            frappe.set_route(\"Form\", \"Purchase BOQ\", res.message[0].name);\r\n                            return;\r\n                        }\r\n\r\n                        frappe.call({\r\n                            method: \"frappe.client.insert\",\r\n                            args: {\r\n                                doc: {\r\n                                    doctype: \"Purchase BOQ\",\r\n                                    sales_boq: frm.doc.name\r\n                                }\r\n                            },\r\n                            freeze: true,\r\n                            freeze_message: \"Creating Purchase BOQ...\",\r\n                            callback(r) {\r\n\r\n                                if (!r.message) {\r\n                                    frappe.msgprint(\"Failed to create Purchase BOQ\");\r\n                                    return;\r\n                                }\r\n\r\n                                frappe.show_alert({\r\n                                    message: \"Purchase BOQ Created Successfully\",\r\n                                    indicator: \"green\"\r\n                                });\r\n\r\n                                frappe.set_route(\"Form\", \"Purchase BOQ\", r.message.name);\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n\r\n            }, \"Actions\");\r\n        }\r\n    },\r\n\r\n    // --------------------------------------------\r\n    // OPPORTUNITY SELECT\r\n    // --------------------------------------------\r\n    opportunity(frm) {\r\n        if (!frm.doc.opportunity) return;\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Opportunity\",\r\n                name: frm.doc.opportunity\r\n            },\r\n            async callback(res) {\r\n                if (!res.message) return;\r\n\r\n                let opp = res.message;\r\n\r\n                frm.set_value(\"opportunity_from\", opp.opportunity_from || \"\");\r\n\r\n                const party_map = {\r\n                    Customer: { field: \"customer_name\" },\r\n                    Lead: { field: \"lead_name\" },\r\n                    Prospect: { field: \"company_name\" }\r\n                };\r\n\r\n                let party_display = \"\";\r\n                let cfg = party_map[opp.opportunity_from];\r\n\r\n                if (cfg && opp.party_name) {\r\n                    try {\r\n                        let party_res = await frappe.db.get_value(\r\n                            opp.opportunity_from,\r\n                            opp.party_name,\r\n                            cfg.field\r\n                        );\r\n                        party_display = party_res?.message?.[cfg.field] || \"\";\r\n                    } catch (e) {\r\n                        console.error(e);\r\n                    }\r\n                }\r\n\r\n                if (!party_display) {\r\n                    party_display = opp.customer_name || opp.party_name || \"\";\r\n                }\r\n\r\n                frm.set_value(\"party\", party_display);\r\n            }\r\n        });\r\n    },\r\n\r\n    // --------------------------------------------\r\n    // SEARCH FILTER TRIGGERS\r\n    // --------------------------------------------\r\n    search_item_group(frm) { apply_item_filter(frm); },\r\n    search_item_name(frm) { apply_item_filter(frm); },\r\n    search_moc(frm) { apply_item_filter(frm); },\r\n    search_make(frm) { apply_item_filter(frm); },\r\n    search_size(frm) { apply_item_filter(frm); },\r\n    search_end_connection(frm) { apply_item_filter(frm); },\r\n\r\n    clear(frm) {\r\n        clear_filters(frm);\r\n        apply_item_filter(frm);\r\n    }\r\n});\r\n\r\n\r\n// =====================================================\r\n// SHORT FORM AUTOCOMPLETE\r\n// =====================================================\r\nfunction setup_short_forms_dropdown(frm, field_type, fieldname) {\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Short Forms\",\r\n            filters: { field_name: field_type },\r\n            fields: [\"name\"],\r\n            limit_page_length: 500\r\n        },\r\n        callback(res) {\r\n            if (!res.message?.length) return;\r\n\r\n            let parents = res.message.map(r => r.name);\r\n            let collected = [];\r\n            let remaining = parents.length;\r\n\r\n            parents.forEach(parent => {\r\n                frappe.call({\r\n                    method: \"frappe.client.get\",\r\n                    args: { doctype: \"Short Forms\", name: parent },\r\n                    callback(doc_res) {\r\n                        if (doc_res.message) {\r\n                            Object.keys(doc_res.message).forEach(k => {\r\n                                if (Array.isArray(doc_res.message[k])) {\r\n                                    doc_res.message[k].forEach(row => {\r\n                                        if (row?.name1) collected.push(row.name1);\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n                        if (--remaining === 0)\r\n                            attach_shortforms_autocomplete(frm, fieldname, collected);\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nfunction attach_shortforms_autocomplete(frm, fieldname, list) {\r\n\r\n    list = [...new Set(list.filter(Boolean))].sort();\r\n    let inputEl = get_input_element(fieldname);\r\n    if (!inputEl) return;\r\n\r\n    if (inputEl.awesomeInstance) {\r\n        try { inputEl.awesomeInstance.destroy(); } catch (e) {}\r\n    }\r\n\r\n    const aw = new Awesomplete(inputEl, {\r\n        list,\r\n        minChars: 0,\r\n        autoFirst: true\r\n    });\r\n\r\n    inputEl.awesomeInstance = aw;\r\n\r\n    inputEl.addEventListener(\"focus\", () => {\r\n        try { aw.evaluate(); aw.open(); } catch (e) {}\r\n    });\r\n\r\n    inputEl.addEventListener(\"awesomplete-selectcomplete\", e => {\r\n        frm.set_value(fieldname, e.text?.value || inputEl.value);\r\n    });\r\n}\r\n\r\n\r\n// =====================================================\r\n// UTILITIES\r\n// =====================================================\r\nfunction get_input_element(fieldname) {\r\n    return cur_frm.fields_dict[fieldname]?.$input?.[0] ||\r\n        document.querySelector(`[data-fieldname=\"${fieldname}\"] input`);\r\n}\r\n\r\nfunction clear_filters(frm) {\r\n    [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ].forEach(f => frm.set_value(f, \"\"));\r\n}\r\n\r\nwindow.toggle_search_fields = function (frm) {\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ];\r\n\r\n    const locked = frm.doc.docstatus === 1;\r\n\r\n    fields.forEach(f => {\r\n        frm.set_df_property(f, \"read_only\", locked);\r\n        frm.set_df_property(f, \"hidden\", locked);\r\n    });\r\n\r\n    frm.set_df_property(\"clear\", \"hidden\", locked);\r\n};\r\n\r\nfunction apply_item_filter(frm) {\r\n    frm.fields_dict.items.grid.get_field(\"item_code\").get_query = () => {\r\n        let f = {};\r\n\r\n        if (frm.doc.search_item_group) f.item_group = frm.doc.search_item_group;\r\n        if (frm.doc.search_item_name) f.item_name = [\"like\", `%${frm.doc.search_item_name}%`];\r\n        if (frm.doc.search_moc) f.custom_moc = [\"like\", `%${frm.doc.search_moc}%`];\r\n        if (frm.doc.search_make) f.custom_make = [\"like\", `%${frm.doc.search_make}%`];\r\n        if (frm.doc.search_size) f.custom_size = [\"like\", `%${frm.doc.search_size}%`];\r\n        if (frm.doc.search_end_connection)\r\n            f.custom_end_connection = [\"like\", `%${frm.doc.search_end_connection}%`];\r\n\r\n        return { filters: f };\r\n    };\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-29 10:56:59.889784",
  "module": "Stock",
  "name": "MOC",
  "script": "frappe.ui.form.on('Item', {\r\n    onload(frm) {\r\n        console.clear();\r\n        console.log(\"START: Attach MOC autocomplete for custom_moc\");\r\n\r\n        // small helper to get the input element robustly\r\n        function get_input_el() {\r\n            let el;\r\n            try { el = frm.fields_dict.custom_moc?.$input?.[0]; } catch(e){}\r\n            if (!el) try { el = frm.fields_dict.custom_moc?.input?.[0]; } catch(e){}\r\n            if (!el) try { el = document.querySelector('[data-fieldname=\"custom_moc\"] input'); } catch(e){}\r\n            if (!el) try { el = document.querySelector('input[data-fieldname=\"custom_moc\"]'); } catch(e){}\r\n            if (!el) {\r\n                const labels = Array.from(document.querySelectorAll('.form-group label'));\r\n                const lab = labels.find(l => /custom[_\\s]?moc|moc/i.test(l.textContent));\r\n                if (lab) {\r\n                    const wrapper = lab.closest('.form-group') || lab.parentElement;\r\n                    el = wrapper && wrapper.querySelector('input');\r\n                }\r\n            }\r\n            return el || null;\r\n        }\r\n\r\n        // Fetch all name1 from Short Forms -> Short-Forms where field_name = \"MOC\"\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: { doctype: \"Short Forms\", filters: { field_name: \"MOC\" }, fields: [\"name\"], limit_page_length: 500 },\r\n            callback: function(list_res) {\r\n                if (!list_res?.message?.length) {\r\n                    console.warn(\"No Short Forms parents with field_name = MOC\");\r\n                    return;\r\n                }\r\n\r\n                const parents = list_res.message.map(d => d.name);\r\n                console.log(\"Found parent Short Forms:\", parents);\r\n\r\n                let collected = [];\r\n                let remaining = parents.length;\r\n\r\n                parents.forEach(pname => {\r\n                    frappe.call({\r\n                        method: \"frappe.client.get\",\r\n                        args: { doctype: \"Short Forms\", name: pname },\r\n                        callback: function(doc_res) {\r\n                            if (doc_res?.message) {\r\n                                const doc = doc_res.message;\r\n                                Object.keys(doc).forEach(k => {\r\n                                    const v = doc[k];\r\n                                    if (Array.isArray(v)) {\r\n                                        v.forEach(row => {\r\n                                            if (row?.name1) collected.push(row.name1);\r\n                                        });\r\n                                    }\r\n                                });\r\n                            }\r\n                            if (--remaining === 0) {\r\n                                const unique = [...new Set(collected.filter(x => x))].sort();\r\n                                console.log(\"Collected MOC options:\", unique);\r\n                                attach_ui_with_retries(frm, unique);\r\n                            }\r\n                        },\r\n                        error: function(err) {\r\n                            console.error(\"Error fetching parent\", pname, err);\r\n                            if (--remaining === 0) {\r\n                                const unique = [...new Set(collected.filter(x => x))].sort();\r\n                                attach_ui_with_retries(frm, unique);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            },\r\n            error: function(err) { console.error(\"Failed get_list for Short Forms\", err); }\r\n        });\r\n\r\n        // Retry attaching UI a few times (handles delayed rendering)\r\n        function attach_ui_with_retries(frm, list) {\r\n            let tries = 0;\r\n            const maxTries = 8;\r\n            const interval = setInterval(() => {\r\n                tries++;\r\n                const inputEl = get_input_el();\r\n                if (inputEl) {\r\n                    clearInterval(interval);\r\n                    attach_ui(frm, inputEl, list);\r\n                } else if (tries >= maxTries) {\r\n                    clearInterval(interval);\r\n                    console.error(\"Could not find input element for custom_moc after retries.\");\r\n                    attach_fallback_dropdown(frm, list);\r\n                } else {\r\n                    console.log(\"Waiting for custom_moc input... attempt\", tries);\r\n                }\r\n            }, 300);\r\n        }\r\n\r\n        // Main attach function (Awesomplete + save handling + Add button)\r\n        function attach_ui(frm, inputEl, list) {\r\n            console.log(\"Attaching autocomplete to input:\", inputEl, \" list length:\", list.length);\r\n\r\n            if (inputEl.awesomeInstance) {\r\n                try { inputEl.awesomeInstance.destroy && inputEl.awesomeInstance.destroy(); } catch(e){}\r\n            }\r\n\r\n            const aw = new Awesomplete(inputEl, { list, minChars: 0, autoFirst: true });\r\n            inputEl.awesomeInstance = aw;\r\n\r\n            setTimeout(() => {\r\n                document.querySelectorAll('.awesomplete ul').forEach(ul => {\r\n                    ul.style.zIndex = 999999;\r\n                    ul.style.background = \"#fff\";\r\n                    ul.style.border = \"1px solid #ccc\";\r\n                    ul.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.2)\";\r\n                    ul.style.maxHeight = \"200px\";\r\n                    ul.style.overflowY = \"auto\";\r\n                });\r\n            }, 80);\r\n\r\n            inputEl.addEventListener(\"awesomplete-selectcomplete\", function(e) {\r\n                const val = e.text?.value || inputEl.value;\r\n                frm.set_value(\"custom_moc\", val);\r\n                $(inputEl).trigger('change');\r\n            });\r\n\r\n            inputEl.addEventListener(\"change\", () => frm.set_value(\"custom_moc\", inputEl.value));\r\n            inputEl.addEventListener(\"blur\", () => setTimeout(() => frm.set_value(\"custom_moc\", inputEl.value), 120));\r\n            inputEl.addEventListener(\"focus\", () => { try { aw.evaluate(); aw.open(); } catch(e){} });\r\n\r\n            // Add button logic (fixed)\r\n            const $field_wrapper = $(inputEl).closest('.form-group, .control-input-wrapper, .frappe-control');\r\n            if ($field_wrapper.length) {\r\n                $field_wrapper.find('.add-moc-btn').remove();  // remove any existing button\r\n                const $btn = $(`\r\n                    <div class=\"add-moc-btn\" style=\"margin-top:6px;\">\r\n                        <button type=\"button\" class=\"btn btn-xs btn-default\">\r\n                            Add New MOC\r\n                        </button>\r\n                    </div>\r\n                `);\r\n                $field_wrapper.append($btn);\r\n                $btn.on('click', () => window.location.href = \"/app/short-forms/MOC\");\r\n            }\r\n        }\r\n\r\n        // fallback dropdown rendered to body (if input can't be found)\r\n        function attach_fallback_dropdown(frm, list) {\r\n            $('.custom-moc-dropdown').remove();\r\n            const $dr = $('<div class=\"custom-moc-dropdown\"></div>').css({\r\n                position: 'fixed', right: 20, bottom: 20, width: 320, zIndex: 999999, background: '#fff',\r\n                border: '1px solid #ccc', padding: '8px', boxShadow: '0 2px 10px rgba(0,0,0,0.2)'\r\n            }).appendTo('body');\r\n            $dr.append('<b>MOC options (fallback)</b><hr>');\r\n            list.forEach(v => {\r\n                $('<div></div>').text(v).css({padding:'6px',cursor:'pointer'}).on('click', () => {\r\n                    frm.set_value('custom_moc', v);\r\n                    $dr.remove();\r\n                }).appendTo($dr);\r\n            });\r\n            $('<div style=\"margin-top:8px\"><button class=\"btn btn-xs btn-primary\">Close</button></div>').appendTo($dr).on('click', () => $dr.remove());\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-29 10:57:09.903276",
  "module": "Stock",
  "name": "Make",
  "script": "frappe.ui.form.on('Item', {\r\n    onload(frm) {\r\n        console.clear();\r\n        console.log(\"START: Attach Make autocomplete for custom_make\");\r\n\r\n        // Helper to find input element\r\n        function get_input_el() {\r\n            let el;\r\n            try { el = frm.fields_dict.custom_make?.$input?.[0]; } catch(e){}\r\n            if (!el) try { el = frm.fields_dict.custom_make?.input?.[0]; } catch(e){}\r\n            if (!el) try { el = document.querySelector('[data-fieldname=\"custom_make\"] input'); } catch(e){}\r\n            if (!el) try { el = document.querySelector('input[data-fieldname=\"custom_make\"]'); } catch(e){}\r\n            if (!el) {\r\n                const labels = Array.from(document.querySelectorAll('.form-group label'));\r\n                const lab = labels.find(l => /custom[_\\s]?make|make/i.test(l.textContent));\r\n                if (lab) {\r\n                    const wrapper = lab.closest('.form-group') || lab.parentElement;\r\n                    el = wrapper && wrapper.querySelector('input');\r\n                }\r\n            }\r\n            return el || null;\r\n        }\r\n\r\n        // Fetch all `name1` from Short Forms (child) where field_name = \"Make\"\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"Short Forms\",\r\n                filters: { field_name: \"Make\" },\r\n                fields: [\"name\"],\r\n                limit_page_length: 500\r\n            },\r\n            callback: function(list_res) {\r\n                if (!list_res?.message?.length) {\r\n                    console.warn(\"‚ö†Ô∏è No Short Forms parents with field_name = Make\");\r\n                    return;\r\n                }\r\n\r\n                const parents = list_res.message.map(d => d.name);\r\n                console.log(\"üìò Found parent Short Forms:\", parents);\r\n\r\n                let collected = [];\r\n                let remaining = parents.length;\r\n\r\n                parents.forEach(pname => {\r\n                    frappe.call({\r\n                        method: \"frappe.client.get\",\r\n                        args: { doctype: \"Short Forms\", name: pname },\r\n                        callback: function(doc_res) {\r\n                            if (doc_res?.message) {\r\n                                const doc = doc_res.message;\r\n                                Object.keys(doc).forEach(k => {\r\n                                    const v = doc[k];\r\n                                    if (Array.isArray(v)) {\r\n                                        v.forEach(row => {\r\n                                            if (row && row.name1) collected.push(row.name1);\r\n                                        });\r\n                                    }\r\n                                });\r\n                            }\r\n\r\n                            if (--remaining === 0) {\r\n                                const unique = Array.from(new Set(collected.filter(x => x))).sort();\r\n                                console.log(\"‚úÖ Collected Make options:\", unique);\r\n                                attach_ui_with_retries(frm, unique);\r\n                            }\r\n                        },\r\n                        error: function(err) {\r\n                            console.error(\"Error fetching parent\", pname, err);\r\n                            if (--remaining === 0) {\r\n                                const unique = Array.from(new Set(collected.filter(x => x))).sort();\r\n                                attach_ui_with_retries(frm, unique);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            },\r\n            error: function(err) {\r\n                console.error(\"Failed get_list for Short Forms\", err);\r\n            }\r\n        });\r\n\r\n        // Try attaching UI multiple times until input is visible\r\n        function attach_ui_with_retries(frm, list) {\r\n            let tries = 0;\r\n            const maxTries = 8;\r\n            const interval = setInterval(() => {\r\n                tries++;\r\n                const inputEl = get_input_el();\r\n                if (inputEl) {\r\n                    clearInterval(interval);\r\n                    attach_ui(frm, inputEl, list);\r\n                } else if (tries >= maxTries) {\r\n                    clearInterval(interval);\r\n                    console.error(\"‚ùå Could not find input element for custom_make after retries.\");\r\n                    attach_fallback_dropdown(frm, list);\r\n                } else {\r\n                    console.log(\"‚è≥ Waiting for custom_make input... attempt\", tries);\r\n                }\r\n            }, 300);\r\n        }\r\n\r\n        // Attach Awesomplete and Add button\r\n        function attach_ui(frm, inputEl, list) {\r\n            console.log(\"üéØ Attaching autocomplete for custom_make (list length:\", list.length, \")\");\r\n\r\n            if (inputEl.awesomeInstance) {\r\n                try { inputEl.awesomeInstance.destroy && inputEl.awesomeInstance.destroy(); } catch(e){}\r\n            }\r\n\r\n            const aw = new Awesomplete(inputEl, { list: list, minChars: 0, autoFirst: true });\r\n            inputEl.awesomeInstance = aw;\r\n\r\n            setTimeout(() => {\r\n                document.querySelectorAll('.awesomplete ul').forEach(ul => {\r\n                    ul.style.zIndex = 999999;\r\n                    ul.style.background = \"#fff\";\r\n                    ul.style.border = \"1px solid #ccc\";\r\n                    ul.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.2)\";\r\n                    ul.style.maxHeight = \"200px\";\r\n                    ul.style.overflowY = \"auto\";\r\n                });\r\n            }, 80);\r\n\r\n            inputEl.addEventListener(\"awesomplete-selectcomplete\", function(e) {\r\n                const val = e.text?.value || inputEl.value;\r\n                console.log(\"‚úÖ Selected Make:\", val);\r\n                frm.set_value(\"custom_make\", val);\r\n                inputEl.value = val;\r\n                $(inputEl).trigger('change');\r\n            });\r\n\r\n            inputEl.addEventListener(\"change\", function() {\r\n                const val = inputEl.value;\r\n                console.log(\"‚úèÔ∏è Change -> custom_make:\", val);\r\n                frm.set_value(\"custom_make\", val);\r\n            });\r\n\r\n            inputEl.addEventListener(\"blur\", function() {\r\n                setTimeout(() => {\r\n                    const val = inputEl.value;\r\n                    frm.set_value(\"custom_make\", val);\r\n                }, 120);\r\n            });\r\n\r\n            inputEl.addEventListener(\"focus\", function() {\r\n                try { aw.evaluate(); aw.open(); } catch(e){ console.warn(\"Awesomplete open failed\", e); }\r\n            });\r\n\r\n            try {\r\n                const $field_wrapper = $(inputEl).closest('.form-group, .control-input-wrapper, .frappe-control');\r\n                if ($field_wrapper.length) {\r\n                    $field_wrapper.find('.add-make-btn').remove();\r\n                    const $btn = $(`\r\n                        <div class=\"add-make-btn\" style=\"margin-top:6px;\">\r\n        <button type=\"button\" class=\"btn btn-xs btn-default\">\r\n            Add New Make\r\n        </button>\r\n    </div>\r\n                    `);\r\n                    $field_wrapper.append($btn);\r\n                    $btn.on('click', function() {\r\n                        const route = \"/app/short-forms/Make\";\r\n                        console.log(\"üîó Redirecting to\", route);\r\n                        window.location.href = route;\r\n                    });\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Error adding button\", err);\r\n            }\r\n\r\n            console.log(\"‚úÖ Autocomplete + Save ready for custom_make\");\r\n        }\r\n\r\n        // fallback dropdown (if input not found)\r\n        function attach_fallback_dropdown(frm, list) {\r\n            console.warn(\"‚ö†Ô∏è Fallback dropdown for custom_make\");\r\n            $('.custom-make-dropdown').remove();\r\n            const $dr = $('<div class=\"custom-make-dropdown\"></div>').css({\r\n                position: 'fixed', right: 20, bottom: 20, width: 320, zIndex: 999999,\r\n                background: '#fff', border: '1px solid #ccc', padding: '8px',\r\n                boxShadow: '0 2px 10px rgba(0,0,0,0.2)'\r\n            }).appendTo('body');\r\n            $dr.append('<b>Make options (fallback)</b><hr>');\r\n            list.forEach(v => {\r\n                $('<div></div>').text(v).css({padding:'6px',cursor:'pointer'}).on('click', function(){\r\n                    frm.set_value('custom_make', v);\r\n                    $dr.remove();\r\n                }).appendTo($dr);\r\n            });\r\n            $('<div style=\"margin-top:8px\"><button class=\"btn btn-xs btn-primary\">Close</button></div>').appendTo($dr).on('click', ()=> $dr.remove());\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Technical Offer",
  "enabled": 1,
  "modified": "2025-12-29 11:27:39.278552",
  "module": "BOQ",
  "name": "create Purchase BOQ",
  "script": "frappe.ui.form.on(\"Technical Offer\", {\r\n    refresh(frm) {\r\n\r\n        if (frm.doc.docstatus === 1) {\r\n\r\n            frm.add_custom_button(\"Create Purchase BOQ\", function () {\r\n\r\n                // ------------------------------------------\r\n                // 1Ô∏è‚É£ CHECK if a Purchase BOQ ALREADY EXISTS\r\n                // ------------------------------------------\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Purchase BOQ\",\r\n                        filters: {\r\n                            sales_boq: frm.doc.name  // check link\r\n                        },\r\n                        fields: [\"name\"],\r\n                        limit: 1\r\n                    },\r\n                    callback: function(res) {\r\n\r\n                        if (res.message && res.message.length > 0) {\r\n                            // ------------------------------------------\r\n                            // Existing Purchase BOQ Found ‚Üí OPEN IT\r\n                            // ------------------------------------------\r\n                            frappe.show_alert(\"Opening existing Purchase BOQ...\", \"green\");\r\n                            frappe.set_route(\"Form\", \"Purchase BOQ\", res.message[0].name);\r\n                            return;\r\n                        }\r\n\r\n                        // ------------------------------------------\r\n                        // 2Ô∏è‚É£ NO Purchase BOQ ‚Üí CREATE NEW ONE\r\n                        // ------------------------------------------\r\n                        frappe.call({\r\n                            method: \"frappe.client.insert\",\r\n                            args: {\r\n                                doc: {\r\n                                    doctype: \"Purchase BOQ\",    // SAME AS SALES BOQ\r\n                                    sales_boq: frm.doc.name  // LINK BACK\r\n                                }\r\n                            },\r\n                            freeze: true,\r\n                            freeze_message: \"Creating Purchase BOQ...\",\r\n                            callback: function(r) {\r\n\r\n                                if (!r.message) {\r\n                                    frappe.msgprint(\"Failed to create Purchase BOQ\");\r\n                                    return;\r\n                                }\r\n\r\n                                frappe.show_alert({\r\n                                    message: \"Purchase BOQ Created Successfully\",\r\n                                    indicator: \"green\"\r\n                                });\r\n\r\n                                frappe.set_route(\"Form\", \"Purchase BOQ\", r.message.name);\r\n                            }\r\n                        });\r\n\r\n                    }\r\n                });\r\n\r\n            }, \"Actions\");\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Commercial Offer",
  "enabled": 0,
  "modified": "2025-12-26 11:30:38.715843",
  "module": null,
  "name": "Final BOQ",
  "script": "frappe.ui.form.on(\"Final BOQ\", {\r\n\r\n    purchase_boq: function(frm) {\r\n        if (!frm.doc.purchase_boq) return;\r\n\r\n        frm.clear_table(\"items\");\r\n        frm.clear_table(\"services\");\r\n        frm.refresh_fields([\"items\", \"services\"]);\r\n\r\n        frappe.db.get_doc(\"Purchase BOQ\", frm.doc.purchase_boq).then(purchase_boq => {\r\n\r\n            if (purchase_boq.customer) {\r\n                frm.set_value(\"customer\", purchase_boq.customer);\r\n            }\r\n\r\n            let stock_promises = [];\r\n\r\n            // -------- COPY ITEMS ----------\r\n            (purchase_boq.items || []).forEach(src => {\r\n                const row = frm.add_child(\"items\");\r\n\r\n                frappe.model.set_value(row.doctype, row.name, \"item_code\", src.item_code);\r\n                frappe.model.set_value(row.doctype, row.name, \"item_name\", src.item_name);\r\n                frappe.model.set_value(row.doctype, row.name, \"qyt\", src.qyt || 0);\r\n                frappe.model.set_value(row.doctype, row.name, \"rate\", src.rate || 0);\r\n                frappe.model.set_value(row.doctype, row.name, \"discount\", 0); // percent\r\n\r\n                const amount = (src.qyt || 0) * (src.rate || 0);\r\n                frappe.model.set_value(row.doctype, row.name, \"amount\", amount);\r\n\r\n                // fetch stock\r\n                if (src.item_code) {\r\n                    const p = new Promise(resolve => {\r\n                        frappe.call({\r\n                            method: \"frappe.client.get_list\",\r\n                            args: {\r\n                                doctype: \"Bin\",\r\n                                filters: { item_code: src.item_code },\r\n                                fields: [\"actual_qty\"]\r\n                            },\r\n                            callback: function(r) {\r\n                                let total = 0;\r\n                                if (r.message?.length) {\r\n                                    total = r.message.reduce((s, b) => s + (b.actual_qty || 0), 0);\r\n                                }\r\n                                frappe.model.set_value(row.doctype, row.name, \"current_stock\", total);\r\n                                resolve();\r\n                            }\r\n                        });\r\n                    });\r\n                    stock_promises.push(p);\r\n                }\r\n            });\r\n\r\n            // -------- COPY SERVICES ----------\r\n            (purchase_boq.services || []).forEach(src => {\r\n                const row = frm.add_child(\"services\");\r\n\r\n                frappe.model.set_value(row.doctype, row.name, \"service_code\", src.service_code);\r\n                frappe.model.set_value(row.doctype, row.name, \"service_name\", src.service_name);\r\n                frappe.model.set_value(row.doctype, row.name, \"description\", src.description);\r\n                frappe.model.set_value(row.doctype, row.name, \"service_cost\", src.service_cost || 0);\r\n                frappe.model.set_value(row.doctype, row.name, \"discount\", 0); // percent\r\n\r\n                frappe.model.set_value(row.doctype, row.name, \"amount\", src.service_cost || 0);\r\n            });\r\n\r\n            Promise.all(stock_promises).then(() => {\r\n                frm.refresh_fields([\"items\", \"services\"]);\r\n                highlight_low_stock(frm);\r\n                calculate_totals(frm);\r\n            });\r\n        });\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        highlight_low_stock(frm);\r\n    },\r\n\r\n    items_add: function(frm) { calculate_totals(frm); highlight_low_stock(frm); },\r\n    items_remove: function(frm) { calculate_totals(frm); highlight_low_stock(frm); },\r\n    services_add: function(frm) { calculate_totals(frm); },\r\n    services_remove: function(frm) { calculate_totals(frm); }\r\n});\r\n\r\n\r\n// ------------------------ CHILD TABLE EVENTS ------------------------\r\n\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt: recalc_item,\r\n    rate: recalc_item,\r\n    discount: recalc_item\r\n});\r\n\r\nfunction recalc_item(frm, cdt, cdn) {\r\n    const d = locals[cdt][cdn];\r\n\r\n    const qty = d.qyt || 0;\r\n    const rate = d.rate || 0;\r\n    const disc = d.discount || 0;\r\n\r\n    const amount = qty * rate;\r\n    const discount_amt = amount * (disc / 100);\r\n    const final_amt = amount - discount_amt;\r\n\r\n    frappe.model.set_value(cdt, cdn, \"amount\", amount);\r\n    frappe.model.set_value(cdt, cdn, \"final_amount\", final_amt);\r\n\r\n    calculate_totals(frm);\r\n}\r\n\r\n// -------- SERVICES ---------\r\n\r\nfrappe.ui.form.on(\"Purchase Services\", {\r\n    service_cost: recalc_service,\r\n    discount: recalc_service\r\n});\r\n\r\nfunction recalc_service(frm, cdt, cdn) {\r\n    const d = locals[cdt][cdn];\r\n\r\n    const cost = d.service_cost || 0;\r\n    const disc = d.discount || 0;\r\n\r\n    const discount_amt = cost * (disc / 100);\r\n    const final_amt = cost - discount_amt;\r\n\r\n    frappe.model.set_value(cdt, cdn, \"amount\", cost);\r\n    frappe.model.set_value(cdt, cdn, \"final_amount\", final_amt);\r\n\r\n    calculate_totals(frm);\r\n}\r\n\r\n\r\n// ------------------------ CALCULATE TOTALS ------------------------\r\n\r\nfunction calculate_totals(frm) {\r\n    let item_total = 0;\r\n    let service_total = 0;\r\n\r\n    // -------- ITEMS ----------\r\n    (frm.doc.items || []).forEach(d => {\r\n        const qty = d.qyt || d.qty || 0;\r\n        const rate = d.rate || 0;\r\n        const disc = d.discount || 0;\r\n\r\n        const amount = qty * rate;\r\n        const discount_amount = amount * (disc / 100);\r\n        const final_amount = amount - discount_amount;\r\n\r\n        // update displayed fields (if exist)\r\n        frappe.model.set_value(d.doctype, d.name, \"amount\", amount);\r\n        frappe.model.set_value(d.doctype, d.name, \"discount_amount\", discount_amount);\r\n        frappe.model.set_value(d.doctype, d.name, \"final_amount\", final_amount);\r\n\r\n        item_total += final_amount;\r\n    });\r\n\r\n    // -------- SERVICES ----------\r\n    (frm.doc.services || []).forEach(d => {\r\n        const cost = d.service_cost || 0;\r\n        const disc = d.discount || 0;\r\n\r\n        const discount_amount = cost * (disc / 100);\r\n        const final_amount = cost - discount_amount;\r\n\r\n        frappe.model.set_value(d.doctype, d.name, \"amount\", cost);\r\n        frappe.model.set_value(d.doctype, d.name, \"discount_amount\", discount_amount);\r\n        frappe.model.set_value(d.doctype, d.name, \"final_amount\", final_amount);\r\n\r\n        service_total += final_amount;\r\n    });\r\n\r\n    // -------- TOTALS ----------\r\n    frm.set_value(\"item_total\", item_total);\r\n    frm.set_value(\"services_total\", service_total);\r\n    frm.set_value(\"grand_total\", item_total + service_total);\r\n\r\n    frm.refresh_fields();\r\n}\r\n\r\n\r\n\r\n// ------------------------ STOCK HIGHLIGHT ------------------------\r\n\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict[\"items\"]?.grid?.grid_rows?.length) return;\r\n\r\n    setTimeout(() => {\r\n        frm.fields_dict[\"items\"].grid.grid_rows.forEach(r => {\r\n            const d = r.doc;\r\n            $(r.row).css(\"background-color\",\r\n                d.current_stock < d.qyt ? \"#ffcccc\" : \"\"\r\n            );\r\n        });\r\n    }, 200);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase BOQ",
  "enabled": 0,
  "modified": "2025-12-26 11:52:59.304946",
  "module": null,
  "name": "BOQ",
  "script": "// ----------------------\r\n// PURCHASE BOQ SCRIPT\r\n// ----------------------\r\n\r\nfrappe.ui.form.on(\"Purchase BOQ\", {\r\n\r\n    // Trigger when Sales BOQ is selected\r\n    sales_boq(frm) {\r\n\r\n        if (!frm.doc.sales_boq) return;\r\n\r\n        frappe.show_alert(\"Fetching Sales BOQ...\", \"blue\");\r\n\r\n        // Clear old rows\r\n        frm.clear_table(\"items\");\r\n        frm.clear_table(\"services\");\r\n        frm.refresh_fields([\"items\", \"services\"]);\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Sales BOQ\",\r\n                name: frm.doc.sales_boq\r\n            },\r\n            freeze: true,\r\n            freeze_message: \"Loading Sales BOQ...\",\r\n            callback: function(r) {\r\n\r\n                if (!r.message) {\r\n                    frappe.msgprint(\"No Sales BOQ found\");\r\n                    return;\r\n                }\r\n\r\n                let sales = r.message;\r\n                let stock_promises = [];\r\n\r\n                // Set customer\r\n                if (sales.customer) {\r\n                    frm.set_value(\"customer\", sales.customer);\r\n                }\r\n\r\n                // ------------------\r\n                // COPY ITEMS\r\n                // ------------------\r\n                (sales.items || []).forEach(src => {\r\n\r\n                    let child = frm.add_child(\"items\");\r\n\r\n                    child.item_category = src.item_category;\r\n                    child.item_code     = src.item_code;\r\n                    child.item_name     = src.item_name;\r\n                    child.qyt           = src.qyt;\r\n                    child.uom           = src.uom;\r\n\r\n                    // fetch standard_rate\r\n                    if (child.item_code) {\r\n\r\n                        frappe.call({\r\n                            method: \"frappe.client.get_value\",\r\n                            args: {\r\n                                doctype: \"Item\",\r\n                                filters: { name: child.item_code },\r\n                                fieldname: \"standard_rate\"\r\n                            },\r\n                            callback: function(r) {\r\n                                child.rate   = r.message?.standard_rate || 0;\r\n                                child.amount = (child.rate || 0) * (child.qyt || 0);\r\n                                frm.refresh_field(\"items\");\r\n                            }\r\n                        });\r\n\r\n                        // stock fetch with Promise\r\n                        let p = new Promise(resolve => {\r\n                            frappe.call({\r\n                                method: \"frappe.client.get_list\",\r\n                                args: {\r\n                                    doctype: \"Bin\",\r\n                                    filters: { item_code: child.item_code },\r\n                                    fields: [\"actual_qty\"]\r\n                                },\r\n                                callback: stock => {\r\n                                    let total = 0;\r\n                                    if (stock.message?.length) {\r\n                                        total = stock.message.reduce((a, s) => a + (s.actual_qty || 0), 0);\r\n                                    }\r\n                                    child.current_stock = total;\r\n                                    resolve();\r\n                                }\r\n                            });\r\n                        });\r\n\r\n                        stock_promises.push(p);\r\n                    }\r\n                });\r\n\r\n                // ------------------\r\n                // COPY SERVICES\r\n                // ------------------\r\n                (sales.services || []).forEach(src => {\r\n\r\n                    let child = frm.add_child(\"services\");\r\n\r\n                    child.service_code = src.service_code;\r\n                    child.service_name = src.service_name;\r\n                    child.description  = src.description;\r\n                    child.service_cost = src.service_cost || 0;\r\n                    child.discount     = 0;\r\n\r\n                });\r\n\r\n                // finish\r\n                Promise.all(stock_promises).then(() => {\r\n                    frm.refresh_fields([\"items\", \"services\"]);\r\n                    highlight_low_stock(frm);\r\n                    frappe.show_alert(\"Items & Services Loaded ‚úî\", \"green\");\r\n                });\r\n            }\r\n        });\r\n    },\r\n\r\n    // Auto trigger on new doc load\r\n    onload(frm) {\r\n        if (frm.doc.sales_boq && frm.is_new()) {\r\n            frm.trigger(\"sales_boq\");\r\n        }\r\n    },\r\n\r\n    // Refresh UI\r\n    refresh(frm) {\r\n        highlight_low_stock(frm);\r\n\r\n        // Auto refetch if table empty\r\n        if (frm.doc.sales_boq && (!frm.doc.items?.length && !frm.doc.services?.length)) {\r\n            frm.trigger(\"sales_boq\"); // FIXED\r\n        }\r\n\r\n        // Create Final BOQ Button only if submitted\r\n        if (frm.doc.docstatus === 1 || frm.doc.docstatus === 0) {\r\n            frm.add_custom_button(\"Create Final BOQ\", function () {\r\n    \r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Final BOQ\",\r\n            filters: {\r\n                purchase_boq: frm.doc.name\r\n            },\r\n            fields: [\"name\"],\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n\r\n            if (r.message && r.message.length > 0) {\r\n                // -------------------------------------\r\n                // FINAL BOQ ALREADY EXISTS ‚Üí OPEN IT\r\n                // -------------------------------------\r\n                frappe.show_alert(\"Opening existing Final BOQ...\", \"green\");\r\n                frappe.set_route(\"Form\", \"Final BOQ\", r.message[0].name);\r\n                return;\r\n            }\r\n\r\n            // -------------------------------------\r\n            // NO FINAL BOQ ‚Üí CREATE NEW ONE\r\n            // -------------------------------------\r\n            frappe.model.with_doctype(\"Final BOQ\", () => {\r\n                let doc = frappe.model.get_new_doc(\"Final BOQ\");\r\n                doc.purchase_boq = frm.doc.name;\r\n\r\n                frappe.set_route(\"Form\", doc.doctype, doc.name);\r\n            });\r\n\r\n        }\r\n    });\r\n\r\n}, \"Actions\");\r\n        }\r\n    }\r\n});\r\n\r\n// ------------------\r\n// ITEM EVENTS\r\n// ------------------\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        row.amount = (row.qyt || 0) * (row.rate || 0);\r\n        frm.refresh_field(\"items\");\r\n    },\r\n    rate(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        row.amount = (row.qyt || 0) * (row.rate || 0);\r\n        frm.refresh_field(\"items\");\r\n    }\r\n});\r\n\r\n// ------------------\r\n// HIGHLIGHT LOW STOCK\r\n// ------------------\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict.items?.grid?.grid_rows) return;\r\n\r\n    setTimeout(() => {\r\n        frm.fields_dict.items.grid.grid_rows.forEach(row => {\r\n            let d = row.doc;\r\n            $(row.row).css(\r\n                \"background-color\",\r\n                d.current_stock < d.qyt ? \"#ffcccc\" : \"\"\r\n            );\r\n        });\r\n    }, 300);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Commercial Offer",
  "enabled": 1,
  "modified": "2026-01-02 15:41:33.018091",
  "module": "BOQ",
  "name": "BOQ Final",
  "script": "// final_boq.js (Client Script)\r\n\r\nfrappe.ui.form.on(\"Commercial Offer\", {\r\n\r\n    purchase_boq: function(frm) {\r\n        if (!frm.doc.purchase_boq) return;\r\n\r\n        frappe.dom.freeze(__(\"Loading Purchase BOQ data...\"));\r\n\r\n        frappe.call({\r\n            method: \"boq.boq.doctype.commercial_offer.commercial_offer.get_purchase_boq_data\",\r\n            args: {\r\n                purchase_boq: frm.doc.purchase_boq\r\n            },\r\n            callback: function(r) {\r\n                frappe.dom.unfreeze();\r\n\r\n                if (!r.message) {\r\n                    frappe.msgprint(__(\"Unable to load Purchase BOQ data\"));\r\n                    return;\r\n                }\r\n\r\n                const data = r.message;\r\n\r\n                frm.clear_table(\"items\");\r\n                frm.clear_table(\"services\");\r\n\r\n                if (data.opportunity) frm.set_value(\"opportunity\", data.opportunity);\r\n                if (data.opportunity_from) frm.set_value(\"opportunity_from\", data.opportunity_from);\r\n                if (data.party) frm.set_value(\"party\", data.party);\r\n\r\n                (data.items || []).forEach(item => frm.add_child(\"items\", item));\r\n                (data.services || []).forEach(service => frm.add_child(\"services\", service));\r\n\r\n                frm.refresh_fields([\"items\", \"services\"]);\r\n                highlight_low_stock(frm);\r\n\r\n                frappe.show_alert({\r\n                    message: __(\"Purchase BOQ data loaded successfully\"),\r\n                    indicator: \"green\"\r\n                }, 3);\r\n            }\r\n        });\r\n    },\r\n\r\n    project: function(frm) {\r\n        if (!frm.doc.project || !frm.doc.name) return;\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.set_value\",\r\n            args: {\r\n                doctype: \"Project\",\r\n                name: frm.doc.project,\r\n                fieldname: {\r\n                    custom_commercial_offer: frm.doc.name\r\n                }\r\n            },\r\n            callback: function() {\r\n                frappe.show_alert({\r\n                    message: __(\"Project linked to this Commercial Offer\"),\r\n                    indicator: \"green\"\r\n                });\r\n            }\r\n        });\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        highlight_low_stock(frm);\r\n\r\n        // Only show \"Create Sales Order\" for submitted Commercial Offers\r\n        if (frm.doc.docstatus === 1) {\r\n            frm.add_custom_button(__('Create Sales Order'), () => {\r\n                frappe.call({\r\n                    method: \"boq.boq.doctype.commercial_offer.commercial_offer.make_sales_order\",\r\n                    args: {\r\n                        commercial_offer: frm.doc.name\r\n                    },\r\n                    callback(r) {\r\n                        if (r.message) {\r\n                            frappe.set_route(\"Form\", \"Sales Order\", r.message);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n        }\r\n    },\r\n\r\n    before_save: function(frm) {\r\n        frm.refresh_fields([\"items\", \"services\"]);\r\n    }\r\n});\r\n\r\n// Child table events\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt: function(frm, cdt, cdn) { highlight_low_stock(frm); frm.dirty(); },\r\n    rate: function(frm, cdt, cdn) { frm.dirty(); },\r\n    discount: function(frm, cdt, cdn) { frm.dirty(); }\r\n});\r\n\r\nfrappe.ui.form.on(\"Purchase Services\", {\r\n    service_cost: function(frm, cdt, cdn) { frm.dirty(); },\r\n    discount: function(frm, cdt, cdn) { frm.dirty(); }\r\n});\r\n\r\n// Visual stock highlighting\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict[\"items\"]?.grid?.grid_rows?.length) return;\r\n\r\n    setTimeout(() => {\r\n        frm.fields_dict[\"items\"].grid.grid_rows.forEach(row => {\r\n            const item = row.doc;\r\n            const qty_needed = item.qyt || 0;\r\n            const stock = item.current_stock || 0;\r\n\r\n            if (stock < qty_needed) {\r\n                $(row.row).css(\"background-color\", \"#ffcccc\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"color\", \"#d9534f\").css(\"font-weight\", \"bold\");\r\n            } else {\r\n                $(row.row).css(\"background-color\", \"\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"color\", \"\").css(\"font-weight\", \"\");\r\n            }\r\n        });\r\n    }, 200);\r\n}\r\n\r\n// ------------------------\r\n// Create Sales Order\r\n// ------------------------\r\nfunction create_sales_order(frm) {\r\n    frappe.new_doc(\"Sales Order\");\r\n\r\n    let interval = setInterval(() => {\r\n        if (cur_frm?.doctype === \"Sales Order\" && cur_frm.doc.__islocal) {\r\n            clearInterval(interval);\r\n\r\n            // Header\r\n            frappe.model.set_value(cur_frm.doc.doctype, cur_frm.doc.name, \"customer\", frm.doc.customer_link);\r\n            frappe.model.set_value(cur_frm.doc.doctype, cur_frm.doc.name, \"opportunity\", frm.doc.opportunity);\r\n            frappe.model.set_value(cur_frm.doc.doctype, cur_frm.doc.name, \"ignore_pricing_rule\", 1);\r\n            frappe.model.set_value(cur_frm.doc.doctype, cur_frm.doc.name, \"selling_price_list\", \"\");\r\n\r\n            // Items\r\n            frm.doc.items?.forEach(item => {\r\n                let row = frappe.model.add_child(\r\n                    cur_frm.doc,\r\n                    \"Sales Order Item\",\r\n                    \"items\"\r\n                );\r\n\r\n                // üîë store custom rate temporarily\r\n                frappe.model.set_value(row.doctype, row.rate, \"item_code\", item.rate);\r\n                frappe.model.set_value(row.doctype, row.name, \"item_code\", item.item_code);\r\n                frappe.model.set_value(row.doctype, row.name, \"qty\", flt(item.qyt || 1));\r\n                frappe.model.set_value(row.doctype, row.name, \"uom\", item.uom);\r\n            });\r\n\r\n            cur_frm.refresh_field(\"items\");\r\n        }\r\n    }, 300);\r\n}\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase BOQ",
  "enabled": 1,
  "modified": "2025-12-31 11:41:53.039139",
  "module": "BOQ",
  "name": "BOQ Purchase",
  "script": "// purchase_boq.js (Client Script)\r\n\r\nfrappe.ui.form.on(\"Purchase BOQ\", {\r\n\r\n    sales_boq: function(frm) {\r\n        if (!frm.doc.sales_boq) return;\r\n\r\n        frappe.dom.freeze(__(\"Loading Technical Offer data...\"));\r\n\r\n        frappe.call({\r\n            method: \"boq.boq.doctype.purchase_boq.purchase_boq.get_sales_boq_data\",\r\n            args: {\r\n                sales_boq: frm.doc.sales_boq\r\n            },\r\n            callback: function(r) {\r\n                frappe.dom.unfreeze();\r\n\r\n                if (!r.message) {\r\n                    frappe.msgprint(__(\"Unable to load Technical Offer data\"));\r\n                    return;\r\n                }\r\n\r\n                const data = r.message;\r\n\r\n                frm.clear_table(\"items\");\r\n                frm.clear_table(\"services\");\r\n\r\n                \r\n                if (data.opportunity) {\r\n                    frm.set_value(\"opportunity\", data.opportunity);\r\n                }\r\n                \r\n                if (data.opportunity_from) {\r\n                    frm.set_value(\"opportunity_from\", data.opportunity_from);\r\n                }\r\n                \r\n                if (data.party) {\r\n                    frm.set_value(\"party\", data.party);\r\n                }\r\n\r\n                (data.items || []).forEach(item => {\r\n                    frm.add_child(\"items\", item);\r\n                });\r\n\r\n                (data.services || []).forEach(service => {\r\n                    frm.add_child(\"services\", service);\r\n                });\r\n\r\n                frm.refresh_fields([\"items\", \"services\"]);\r\n                highlight_low_stock(frm);\r\n\r\n                frappe.show_alert({\r\n                    message: __(\"Items & Services Loaded ‚úî\"),\r\n                    indicator: \"green\"\r\n                }, 3);\r\n            }\r\n        });\r\n    },\r\n\r\n    onload: function(frm) {\r\n        if (frm.doc.sales_boq && frm.is_new()) {\r\n            frm.trigger(\"sales_boq\");\r\n        }\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        highlight_low_stock(frm);\r\n\r\n        if (frm.doc.sales_boq && (!frm.doc.items?.length && !frm.doc.services?.length)) {\r\n            frm.trigger(\"sales_boq\");\r\n        }\r\n\r\n        if (frm.doc.docstatus === 1 || frm.doc.docstatus === 0) {\r\n            frm.add_custom_button(__(\"Create Commercial Offer\"), function() {\r\n                \r\n                frappe.call({\r\n                    method: \"boq.boq.doctype.purchase_boq.purchase_boq.check_final_boq_exists\",\r\n                    args: {\r\n                        purchase_boq: frm.doc.name\r\n                    },\r\n                    callback: function(r) {\r\n                        if (r.message && r.message.exists) {\r\n                            frappe.show_alert({\r\n                                message: __(\"Opening existing Commercial Offers...\"),\r\n                                indicator: \"green\"\r\n                            });\r\n                            frappe.set_route(\"Form\", \"Commercial Offer\", r.message.name);\r\n                        } else {\r\n                            frappe.model.with_doctype(\"Commercial Offer\", () => {\r\n                                let doc = frappe.model.get_new_doc(\"Commercial Offer\");\r\n                                doc.purchase_boq = frm.doc.name;\r\n                                frappe.set_route(\"Form\", doc.doctype, doc.name);\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n\r\n            }, __(\"Actions\"));\r\n        }\r\n    }\r\n});\r\n\r\n\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt: function(frm, cdt, cdn) {\r\n        highlight_low_stock(frm);\r\n        frm.dirty();\r\n    },\r\n    rate: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    },\r\n    discount: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on(\"Purchase Services\", {\r\n    service_cost: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    },\r\n    discount: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    }\r\n});\r\n\r\n\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict.items?.grid?.grid_rows) return;\r\n\r\n    setTimeout(() => {\r\n        frm.fields_dict.items.grid.grid_rows.forEach(row => {\r\n            const item = row.doc;\r\n            const qty_needed = item.qyt || 0;\r\n            const stock = item.current_stock || 0;\r\n\r\n            if (stock < qty_needed) {\r\n                $(row.row).css(\"background-color\", \"#ffcccc\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css({\r\n                    \"color\": \"#d9534f\",\r\n                    \"font-weight\": \"bold\"\r\n                });\r\n            } else {\r\n                $(row.row).css(\"background-color\", \"\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css({\r\n                    \"color\": \"\",\r\n                    \"font-weight\": \"\"\r\n                });\r\n            }\r\n        });\r\n    }, 300);\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Technical Offer",
  "enabled": 0,
  "modified": "2025-12-26 12:46:45.288753",
  "module": null,
  "name": "Sales BOQ",
  "script": "// sales_boq.js (Client Script - Complete)\r\n\r\nfrappe.ui.form.on(\"Sales BOQ\", {\r\n\r\n    onload: function(frm) {\r\n        load_short_forms_autocomplete(frm, \"MOC\", \"search_moc\");\r\n        load_short_forms_autocomplete(frm, \"Make\", \"search_make\");\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        load_short_forms_autocomplete(frm, \"MOC\", \"search_moc\");\r\n        load_short_forms_autocomplete(frm, \"Make\", \"search_make\");\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n\r\n        // Create Purchase BOQ Button (only when submitted)\r\n        if (frm.doc.docstatus === 1) {\r\n            frm.add_custom_button(__(\"Create Purchase BOQ\"), function() {\r\n                \r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Purchase BOQ\",\r\n                        filters: {\r\n                            sales_boq: frm.doc.name\r\n                        },\r\n                        fields: [\"name\"],\r\n                        limit: 1\r\n                    },\r\n                    callback: function(r) {\r\n                        if (r.message && r.message.length > 0) {\r\n                            frappe.show_alert({\r\n                                message: __(\"Opening existing Purchase BOQ...\"),\r\n                                indicator: \"green\"\r\n                            });\r\n                            frappe.set_route(\"Form\", \"Purchase BOQ\", r.message[0].name);\r\n                        } else {\r\n                            frappe.call({\r\n                                method: \"frappe.client.insert\",\r\n                                args: {\r\n                                    doc: {\r\n                                        doctype: \"Purchase BOQ\",\r\n                                        sales_boq: frm.doc.name\r\n                                    }\r\n                                },\r\n                                freeze: true,\r\n                                freeze_message: __(\"Creating Purchase BOQ...\"),\r\n                                callback: function(res) {\r\n                                    if (res.message) {\r\n                                        frappe.show_alert({\r\n                                            message: __(\"Purchase BOQ Created Successfully\"),\r\n                                            indicator: \"green\"\r\n                                        });\r\n                                        frappe.set_route(\"Form\", \"Purchase BOQ\", res.message.name);\r\n                                    } else {\r\n                                        frappe.msgprint(__(\"Failed to create Purchase BOQ\"));\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n\r\n            }, __(\"Actions\"));\r\n        }\r\n    },\r\n\r\n    // Trigger filter when search fields change\r\n    search_item_group: function(frm) { apply_item_filter(frm); },\r\n    search_item_name: function(frm) { apply_item_filter(frm); },\r\n    search_moc: function(frm) { apply_item_filter(frm); },\r\n    search_make: function(frm) { apply_item_filter(frm); },\r\n    search_size: function(frm) { apply_item_filter(frm); },\r\n    search_end_connection: function(frm) { apply_item_filter(frm); },\r\n\r\n    // Clear button\r\n    clear: function(frm) {\r\n        clear_filters(frm);\r\n        apply_item_filter(frm);\r\n    }\r\n});\r\n\r\n\r\n// ----------------------\r\n// LOAD SHORT FORMS - COMPLETE CLIENT SIDE\r\n// ----------------------\r\nfunction load_short_forms_autocomplete(frm, field_type, fieldname) {\r\n    \r\n    // Fetch parent Short Forms documents\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Short Forms\",\r\n            filters: { field_name: field_type },\r\n            fields: [\"name\"],\r\n            limit_page_length: 500\r\n        },\r\n        callback: function(res) {\r\n            if (!res.message || !res.message.length) {\r\n                console.log(\"No Short Forms found for\", field_type);\r\n                return;\r\n            }\r\n\r\n            let parents = res.message.map(r => r.name);\r\n            let collected = [];\r\n            let completed = 0;\r\n\r\n            // Fetch each parent document with child table data\r\n            parents.forEach(parent_name => {\r\n                frappe.call({\r\n                    method: \"frappe.client.get\",\r\n                    args: {\r\n                        doctype: \"Short Forms\",\r\n                        name: parent_name\r\n                    },\r\n                    callback: function(doc_res) {\r\n                        if (doc_res.message) {\r\n                            let doc = doc_res.message;\r\n                            \r\n                            // Loop through all keys to find child tables\r\n                            Object.keys(doc).forEach(key => {\r\n                                if (Array.isArray(doc[key])) {\r\n                                    doc[key].forEach(row => {\r\n                                        if (row && row.name1) {\r\n                                            collected.push(row.name1);\r\n                                        }\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        completed++;\r\n                        \r\n                        // When all parents are fetched, setup autocomplete\r\n                        if (completed === parents.length) {\r\n                            // Remove duplicates and sort\r\n                            let unique_list = [...new Set(collected)].filter(x => x).sort();\r\n                            console.log(`Loaded ${unique_list.length} items for ${fieldname}`);\r\n                            setup_custom_autocomplete(frm, fieldname, unique_list);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n// ----------------------\r\n// CUSTOM AUTOCOMPLETE DROPDOWN\r\n// ----------------------\r\nfunction setup_custom_autocomplete(frm, fieldname, options) {\r\n    \r\n    let field = frm.fields_dict[fieldname];\r\n    if (!field || !field.$input) {\r\n        console.log(\"Field not found:\", fieldname);\r\n        return;\r\n    }\r\n    \r\n    let $input = field.$input;\r\n    \r\n    // Remove any existing autocomplete\r\n    $input.off('input.custom_ac focus.custom_ac');\r\n    $('.custom-autocomplete-dropdown').remove();\r\n    \r\n    // Show dropdown on input\r\n    $input.on('input.custom_ac', function() {\r\n        let search_term = $(this).val().toLowerCase().trim();\r\n        \r\n        let filtered = options.filter(opt => \r\n            opt.toLowerCase().includes(search_term)\r\n        );\r\n        \r\n        if (filtered.length > 0) {\r\n            show_dropdown($input, filtered.slice(0, 50), frm, fieldname);\r\n        } else {\r\n            $('.custom-autocomplete-dropdown').remove();\r\n        }\r\n    });\r\n    \r\n    // Show all options on focus\r\n    $input.on('focus.custom_ac', function() {\r\n        let current_val = $(this).val().toLowerCase().trim();\r\n        \r\n        let filtered = options;\r\n        if (current_val) {\r\n            filtered = options.filter(opt => \r\n                opt.toLowerCase().includes(current_val)\r\n            );\r\n        }\r\n        \r\n        show_dropdown($input, filtered.slice(0, 50), frm, fieldname);\r\n    });\r\n    \r\n    console.log(`Autocomplete setup complete for ${fieldname} with ${options.length} options`);\r\n}\r\n\r\n\r\nfunction show_dropdown($input, items, frm, fieldname) {\r\n    \r\n    // Remove existing dropdown\r\n    $('.custom-autocomplete-dropdown').remove();\r\n    \r\n    if (!items || items.length === 0) return;\r\n    \r\n    // Create dropdown container\r\n    let $dropdown = $('<div class=\"custom-autocomplete-dropdown\"></div>');\r\n    \r\n    $dropdown.css({\r\n        'position': 'absolute',\r\n        'background': 'white',\r\n        'border': '1px solid #d1d8dd',\r\n        'border-radius': '4px',\r\n        'max-height': '250px',\r\n        'overflow-y': 'auto',\r\n        'z-index': '9999',\r\n        'box-shadow': '0 4px 12px rgba(0,0,0,0.15)',\r\n        'width': $input.outerWidth() + 'px',\r\n        'margin-top': '2px'\r\n    });\r\n    \r\n    // Add each item\r\n    items.forEach(function(item) {\r\n        let $option = $('<div class=\"autocomplete-item\"></div>');\r\n        $option.text(item);\r\n        \r\n        $option.css({\r\n            'padding': '10px 12px',\r\n            'cursor': 'pointer',\r\n            'border-bottom': '1px solid #f4f5f6',\r\n            'font-size': '13px'\r\n        });\r\n        \r\n        // Hover effect\r\n        $option.hover(\r\n            function() { \r\n                $(this).css({\r\n                    'background-color': '#f8f9fa',\r\n                    'color': '#2490ef'\r\n                }); \r\n            },\r\n            function() { \r\n                $(this).css({\r\n                    'background-color': 'white',\r\n                    'color': '#36414c'\r\n                }); \r\n            }\r\n        );\r\n        \r\n        // Click to select\r\n        $option.on('click', function(e) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            frm.set_value(fieldname, item);\r\n            $dropdown.remove();\r\n            $(document).off('click.custom_dropdown');\r\n        });\r\n        \r\n        $dropdown.append($option);\r\n    });\r\n    \r\n    // Position dropdown below input\r\n    let input_offset = $input.offset();\r\n    let input_height = $input.outerHeight();\r\n    \r\n    $dropdown.css({\r\n        'top': (input_offset.top + input_height) + 'px',\r\n        'left': input_offset.left + 'px'\r\n    });\r\n    \r\n    // Append to body\r\n    $('body').append($dropdown);\r\n    \r\n    // Close dropdown when clicking outside\r\n    setTimeout(function() {\r\n        $(document).on('click.custom_dropdown', function(e) {\r\n            if (!$(e.target).closest('.custom-autocomplete-dropdown').length && \r\n                !$(e.target).is($input)) {\r\n                $dropdown.remove();\r\n                $(document).off('click.custom_dropdown');\r\n            }\r\n        });\r\n    }, 100);\r\n}\r\n\r\n\r\n// ----------------------\r\n// FILTER FUNCTIONS\r\n// ----------------------\r\nfunction apply_item_filter(frm) {\r\n    frm.fields_dict.items.grid.get_field(\"item_code\").get_query = function(doc, cdt, cdn) {\r\n        \r\n        let filters = {};\r\n        \r\n        if (frm.doc.search_item_group)\r\n            filters.item_group = frm.doc.search_item_group;\r\n        \r\n        if (frm.doc.search_item_name)\r\n            filters.item_name = [\"like\", `%${frm.doc.search_item_name}%`];\r\n        \r\n        if (frm.doc.search_moc)\r\n            filters.custom_moc = [\"like\", `%${frm.doc.search_moc}%`];\r\n        \r\n        if (frm.doc.search_make)\r\n            filters.custom_make = [\"like\", `%${frm.doc.search_make}%`];\r\n        \r\n        if (frm.doc.search_size)\r\n            filters.custom_size = [\"like\", `%${frm.doc.search_size}%`];\r\n        \r\n        if (frm.doc.search_end_connection)\r\n            filters.custom_end_connection = [\"like\", `%${frm.doc.search_end_connection}%`];\r\n        \r\n        return { filters: filters };\r\n    };\r\n    \r\n    frm.refresh_field(\"items\");\r\n}\r\n\r\nfunction clear_filters(frm) {\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ];\r\n    \r\n    fields.forEach(f => frm.set_value(f, \"\"));\r\n    frm.refresh_fields();\r\n}\r\n\r\nfunction toggle_search_fields(frm) {\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ];\r\n    \r\n    if (frm.doc.docstatus === 1) {\r\n        // Submitted - hide search fields\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 1);\r\n            frm.set_df_property(f, \"hidden\", 1);\r\n        });\r\n        frm.set_df_property(\"clear\", \"hidden\", 1);\r\n        frm.set_df_property(\"clear\", \"read_only\", 1);\r\n    } else {\r\n        // Draft - show search fields\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 0);\r\n            frm.set_df_property(f, \"hidden\", 0);\r\n        });\r\n        frm.set_df_property(\"clear\", \"hidden\", 0);\r\n        frm.set_df_property(\"clear\", \"read_only\", 0);\r\n    }\r\n    \r\n    frm.refresh_fields();\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-12-31 11:53:37.519134",
  "module": "BOQ",
  "name": "BOQ Project",
  "script": "frappe.ui.form.on(\"Project\", {\r\n\r\n    custom_commercial_offer: function(frm) {\r\n        if (!frm.doc.custom_commercial_offer || !frm.doc.name) return;\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.set_value\",\r\n            args: {\r\n                doctype: \"Commercial Offer\",\r\n                name: frm.doc.custom_commercial_offer,\r\n                fieldname: {\r\n                    project: frm.doc.name\r\n                }\r\n            },\r\n            callback: function() {\r\n                frappe.show_alert({\r\n                    message: __(\"Commercial Offer linked to this Project\"),\r\n                    indicator: \"green\"\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Technical Offer",
  "enabled": 0,
  "modified": "2026-01-02 12:08:36.856232",
  "module": "BOQ",
  "name": "Technical BOQ",
  "script": "// MAIN FORM\r\nfrappe.ui.form.on(\"Technical Offer\", {\r\n\r\n    onload(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n        setup_short_forms_dropdown(frm, \"MOC\", \"search_moc\");\r\n        setup_short_forms_dropdown(frm, \"Make\", \"search_make\");\r\n    },\r\n\r\n    refresh(frm) {\r\n        apply_item_filter(frm);\r\n        toggle_search_fields(frm);\r\n        setup_short_forms_dropdown(frm, \"MOC\", \"search_moc\");\r\n        setup_short_forms_dropdown(frm, \"Make\", \"search_make\");\r\n    },\r\n\r\n    // OPPORTUNITY SELECT - FIXED TO FETCH ACTUAL NAME\r\n    opportunity(frm) {\r\n        if (!frm.doc.opportunity) return;\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Opportunity\",\r\n                name: frm.doc.opportunity\r\n            },\r\n            async callback(res) {\r\n                if (!res.message) return;\r\n\r\n                let opp = res.message;\r\n                \r\n                // Set opportunity_from first\r\n                frm.set_value(\"opportunity_from\", opp.opportunity_from || \"\");\r\n                \r\n                // Map to get the correct field name\r\n                const party_map = {\r\n                    Customer:  { doctype: \"Customer\",  field: \"customer_name\" },\r\n                    Lead:      { doctype: \"Lead\",      field: \"lead_name\" },\r\n                    Prospect:  { doctype: \"Prospect\",  field: \"company_name\" }\r\n                };\r\n                \r\n                let party_display = \"\";\r\n                let cfg = party_map[opp.opportunity_from];\r\n                \r\n                // Fetch the actual customer/lead/prospect name\r\n                if (cfg && opp.party_name) {\r\n                    try {\r\n                        let party_res = await frappe.db.get_value(\r\n                            opp.opportunity_from,\r\n                            opp.party_name,\r\n                            cfg.field\r\n                        );\r\n                        party_display = party_res?.message?.[cfg.field] || \"\";\r\n                    } catch (e) {\r\n                        console.error(\"Error fetching party:\", e);\r\n                    }\r\n                }\r\n                \r\n                // Fallback to customer_name or party_name if fetch fails\r\n                if (!party_display) {\r\n                    party_display = opp.customer_name || opp.party_name || \"\";\r\n                }\r\n                \r\n                // Set the party field with the actual name\r\n                frm.set_value(\"party\", party_display);\r\n            }\r\n        });\r\n    },\r\n\r\n    // RUN FILTER LOGIC WHEN ANY SEARCH FIELD CHANGES\r\n    search_item_group(frm) { apply_item_filter(frm); },\r\n    search_item_name(frm) { apply_item_filter(frm); },\r\n    search_moc(frm)       { apply_item_filter(frm); },\r\n    search_make(frm)      { apply_item_filter(frm); },\r\n    search_size(frm)      { apply_item_filter(frm); },\r\n    search_end_connection(frm) { apply_item_filter(frm); },\r\n\r\n    // CLEAR BUTTON\r\n    clear(frm) {\r\n        clear_filters(frm);\r\n        apply_item_filter(frm);\r\n    }\r\n\r\n});\r\n\r\n// Attach Autocomplete to search_moc & search_make\r\n\r\n// ----------------------\r\n// MAIN FUNCTION\r\n// ----------------------\r\nfunction setup_short_forms_dropdown(frm, field_type, fieldname) {\r\n\r\n    // Fetch parent Short Forms with field_name = \"MOC\" or \"Make\"\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Short Forms\",\r\n            filters: { field_name: field_type },\r\n            fields: [\"name\"],\r\n            limit_page_length: 500\r\n        },\r\n        callback: function(res) {\r\n            if (!res.message || !res.message.length) return;\r\n\r\n            let parents = res.message.map(r => r.name);\r\n            let collected = [];\r\n            let remaining = parents.length;\r\n\r\n            parents.forEach(parent => {\r\n                frappe.call({\r\n                    method: \"frappe.client.get\",\r\n                    args: { doctype: \"Short Forms\", name: parent },\r\n\r\n                    callback: function(doc_res) {\r\n                        if (doc_res.message) {\r\n                            let doc = doc_res.message;\r\n\r\n                            // Get all child rows inside doc (any child table)\r\n                            Object.keys(doc).forEach(k => {\r\n                                if (Array.isArray(doc[k])) {\r\n                                    doc[k].forEach(row => {\r\n                                        if (row?.name1) collected.push(row.name1);\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        if (--remaining === 0)\r\n                            attach_shortforms_autocomplete(frm, fieldname, collected);\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n\r\n// ----------------------\r\n// ATTACH AUTOCOMPLETE\r\n// ----------------------\r\nfunction attach_shortforms_autocomplete(frm, fieldname, list) {\r\n\r\n    list = [...new Set(list.filter(x => x))].sort(); // unique sorted\r\n\r\n    let inputEl = get_input_element(fieldname);\r\n\r\n    if (!inputEl) return; // no input found\r\n\r\n    // Destroy previous instance\r\n    if (inputEl.awesomeInstance) {\r\n        try { inputEl.awesomeInstance.destroy(); } catch (e) {}\r\n    }\r\n\r\n    // Create awesomplete instance\r\n    const aw = new Awesomplete(inputEl, {\r\n        list,\r\n        minChars: 0,\r\n        autoFirst: true\r\n    });\r\n    inputEl.awesomeInstance = aw;\r\n\r\n    // Auto-expand dropdown on focus\r\n    inputEl.addEventListener(\"focus\", () => {\r\n        try { aw.evaluate(); aw.open(); } catch (e) {}\r\n    });\r\n\r\n    inputEl.addEventListener(\"awesomplete-selectcomplete\", function(e) {\r\n        let val = e.text?.value || inputEl.value;\r\n        frm.set_value(fieldname, val);\r\n        $(inputEl).trigger('change');\r\n    });\r\n}\r\n\r\n\r\n// ----------------------\r\n// UTILITY ‚Äì Find input field robustly\r\n// ----------------------\r\nfunction get_input_element(fieldname) {\r\n    let el = null;\r\n\r\n    try {\r\n        el = cur_frm.fields_dict[fieldname]?.$input?.[0];\r\n    } catch (e) {}\r\n\r\n    if (!el) {\r\n        try {\r\n            el = document.querySelector(\r\n                `[data-fieldname=\"${fieldname}\"] input`\r\n            );\r\n        } catch (e) {}\r\n    }\r\n\r\n    if (!el) {\r\n        try {\r\n            el = document.querySelector(\r\n                `input[data-fieldname=\"${fieldname}\"]`\r\n            );\r\n        } catch (e) {}\r\n    }\r\n\r\n    return el;\r\n}\r\n\r\n// CLEAR ALL SEARCH FIELDS\r\nfunction clear_filters(frm) {\r\n\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ];\r\n\r\n    fields.forEach(f => frm.set_value(f, \"\"));\r\n\r\n    frm.refresh_fields();\r\n}\r\n\r\n\r\nwindow.toggle_search_fields = function (frm) {\r\n    const fields = [\r\n        \"search_item_group\",\r\n        \"search_item_name\",\r\n        \"search_moc\",\r\n        \"search_make\",\r\n        \"search_size\",\r\n        \"search_end_connection\"\r\n    ];\r\n\r\n    if (frm.doc.docstatus === 1) {\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 1);\r\n            frm.set_df_property(f, \"hidden\", 1);\r\n        });\r\n        frm.set_df_property(\"clear\", \"hidden\", 1);\r\n        frm.set_df_property(\"clear\", \"read_only\", 1);\r\n    } else {\r\n        fields.forEach(f => {\r\n            frm.set_df_property(f, \"read_only\", 0);\r\n            frm.set_df_property(f, \"hidden\", 0);\r\n        });\r\n        frm.set_df_property(\"clear\", \"hidden\", 0);\r\n        frm.set_df_property(\"clear\", \"read_only\", 0);\r\n    }\r\n\r\n    frm.refresh_fields();\r\n};\r\n\r\n\r\n\r\n// APPLY FILTER TO CHILD TABLE\r\nfunction apply_item_filter(frm) {\r\n    frm.fields_dict.items.grid.get_field(\"item_code\").get_query =\r\n        function (doc, cdt, cdn) {\r\n\r\n            let f = {};\r\n\r\n            if (frm.doc.search_item_group)\r\n                f.item_group = frm.doc.search_item_group;\r\n\r\n            if (frm.doc.search_item_name)\r\n                f.item_name = [\"like\", `%${frm.doc.search_item_name}%`];\r\n\r\n            if (frm.doc.search_moc)\r\n                f.custom_moc = [\"like\", `%${frm.doc.search_moc}%`];\r\n\r\n            if (frm.doc.search_make)\r\n                f.custom_make = [\"like\", `%${frm.doc.search_make}%`];\r\n\r\n            if (frm.doc.search_size)\r\n                f.custom_size = [\"like\", `%${frm.doc.search_size}%`];\r\n\r\n            if (frm.doc.search_end_connection)\r\n                f.custom_end_connection = [\"like\", `%${frm.doc.search_end_connection}%`];\r\n\r\n            return { filters: f };\r\n        };\r\n\r\n    frm.refresh_field(\"items\");\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Commercial Offer",
  "enabled": 0,
  "modified": "2026-01-02 14:08:53.278320",
  "module": "BOQ",
  "name": "Commercial",
  "script": "// final_boq.js (Client Script)\r\n\r\nfrappe.ui.form.on(\"Commercial Offer\", {\r\n    \r\n    purchase_boq: function(frm) {\r\n        if (!frm.doc.purchase_boq) return;\r\n        \r\n        frappe.dom.freeze(__(\"Loading Purchase BOQ data...\"));\r\n        \r\n        frappe.call({\r\n            method: \"boq.boq.doctype.commercial_offer.commercial_offer.get_purchase_boq_data\",\r\n            args: {\r\n                purchase_boq: frm.doc.purchase_boq\r\n            },\r\n            callback: function(r) {\r\n                frappe.dom.unfreeze();\r\n                \r\n                if (!r.message) {\r\n                    frappe.msgprint(__(\"Unable to load Purchase BOQ data\"));\r\n                    return;\r\n                }\r\n                \r\n                const data = r.message;\r\n                \r\n                frm.clear_table(\"items\");\r\n                frm.clear_table(\"services\");\r\n                \r\n                if (data.opportunity) {\r\n                    frm.set_value(\"opportunity\", data.opportunity);\r\n                }\r\n                \r\n                if (data.opportunity_from) {\r\n                    frm.set_value(\"opportunity_from\", data.opportunity_from);\r\n                }\r\n                \r\n                if (data.party) {\r\n                    frm.set_value(\"party\", data.party);\r\n                }\r\n                \r\n                (data.items || []).forEach(item => {\r\n                    frm.add_child(\"items\", item);\r\n                });\r\n                \r\n                (data.services || []).forEach(service => {\r\n                    frm.add_child(\"services\", service);\r\n                });\r\n                \r\n                frm.refresh_fields([\"items\", \"services\"]);\r\n                highlight_low_stock(frm);\r\n                \r\n                frappe.show_alert({\r\n                    message: __(\"Purchase BOQ data loaded successfully\"),\r\n                    indicator: \"green\"\r\n                }, 3);\r\n            }\r\n        });\r\n    },\r\n    \r\n    project: function(frm) {\r\n        if (!frm.doc.project || !frm.doc.name) return;\r\n\r\n        frappe.call({\r\n            method: \"frappe.client.set_value\",\r\n            args: {\r\n                doctype: \"Project\",\r\n                name: frm.doc.project,\r\n                fieldname: {\r\n                    custom_commercial_offer: frm.doc.name\r\n                }\r\n            },\r\n            callback: function() {\r\n                frappe.show_alert({\r\n                    message: __(\"Project linked to this Commercial Offer\"),\r\n                    indicator: \"green\"\r\n                });\r\n            }\r\n        });\r\n    },\r\n    \r\n    refresh: function(frm) {\r\n        highlight_low_stock(frm);\r\n    },\r\n    \r\n    before_save: function(frm) {\r\n        // Calculations will happen on server via validate()\r\n        // Just ensure tables are refreshed\r\n        frm.refresh_fields([\"items\", \"services\"]);\r\n    }\r\n});\r\n\r\n\r\n// Child table events\r\nfrappe.ui.form.on(\"Purchase BOQ Item\", {\r\n    qyt: function(frm, cdt, cdn) {\r\n        highlight_low_stock(frm);\r\n        frm.dirty();\r\n    },\r\n    rate: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    },\r\n    discount: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on(\"Purchase Services\", {\r\n    service_cost: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    },\r\n    discount: function(frm, cdt, cdn) {\r\n        frm.dirty();\r\n    }\r\n});\r\n\r\n\r\n// Visual stock highlighting\r\nfunction highlight_low_stock(frm) {\r\n    if (!frm.fields_dict[\"items\"]?.grid?.grid_rows?.length) return;\r\n    \r\n    setTimeout(() => {\r\n        frm.fields_dict[\"items\"].grid.grid_rows.forEach(row => {\r\n            const item = row.doc;\r\n            const qty_needed = item.qyt || 0;\r\n            const stock = item.current_stock || 0;\r\n            \r\n            if (stock < qty_needed) {\r\n                $(row.row).css(\"background-color\", \"#ffcccc\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"color\", \"#d9534f\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"font-weight\", \"bold\");\r\n            } else {\r\n                $(row.row).css(\"background-color\", \"\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"color\", \"\");\r\n                $(row.row).find(\"[data-fieldname='current_stock']\").css(\"font-weight\", \"\");\r\n            }\r\n        });\r\n    }, 200);\r\n}",
  "view": "Form"
 }
]